<div class="expenses-container">
  <!-- SECCI√ìN 1: RESUMEN DE GASTOS DEL VIAJE -->
  <article class="expenses-summary-card">
    <div class="summary-header">
      <h1 class="total-amount">{{ totalExpenses() | number: '1.2-2' }} ‚Ç¨</h1>
      <p class="summary-label">Gastos totales del viaje</p>
      
      <!-- Informaci√≥n de presupuesto -->
      <div class="budget-info">
        <div class="budget-item">
          <span class="budget-label">Presupuesto:</span>
          <span class="budget-value">{{ tripBudget() | number: '1.2-2' }} ‚Ç¨</span>
        </div>
        <div class="budget-item">
          <span class="budget-label">Restante:</span>
          <span class="budget-remaining" [class.over-budget]="remainingBudget() < 0">{{ remainingBudget() | number: '1.2-2' }} ‚Ç¨</span>
        </div>
        <div class="budget-bar">
          <div class="budget-used" [style.width.%]="budgetPercentage()"></div>
        </div>
        <p class="budget-percentage">{{ budgetPercentage() | number: '1.0-0' }}% del presupuesto utilizado</p>
      </div>
    </div>

    <!-- Listado de gastos agregados por categor√≠a -->
    <div class="aggregated-expenses">
      @if (aggregatedExpenses().length > 0) {
        @for (aggExpense of aggregatedExpenses(); track aggExpense.category) {
          <div class="aggregated-item">
            <div class="item-left">
              <p class="expense-name">{{ aggExpense.description }}</p>
              <p class="expense-subtitle">
                Pagado por: {{ aggExpense.payerNames }}
              </p>
              <p class="expense-date">{{ aggExpense.latestDate | date: 'MMMM d, yyyy' }}</p>
            </div>
            <div class="item-right">
              <span class="expense-amount">{{ aggExpense.total | number: '1.2-2' }} ‚Ç¨</span>
            </div>
          </div>
        }
      } @else {
        <p class="no-expenses-text">Sin gastos a√∫n</p>
      }
    </div>

    <!-- Bot√≥n de acci√≥n -->
    <div class="button-container">
      <button 
        class="btn-add-expense-pill" 
        (click)="openAddExpenseModal()"
        aria-label="A√±adir nuevo gasto">
        S A√±adir Gasto
      </button>
    </div>
  </article>

  <!-- SECCI√ìN 2: CARRUSEL DE D√çAS CON GASTOS -->
  <div class="days-carousel-container">
    <div class="carousel-wrapper">
      @if (tripDateRange().length > 0) {
        @for (date of tripDateRange(); track date; let i = $index) {
          <button 
            class="day-card"
            [class.selected]="selectedDate() === date"
            [style.background-color]="getDayColor(date)"
            (click)="selectDate(date)"
            [attr.aria-pressed]="selectedDate() === date"
            [attr.aria-label]="'D√≠a ' + formatDateForSelector(date).day + ', gastos: ' + (getTotalForDate(date) | number: '1.2-2') + ' ‚Ç¨'">
            <div class="day-number">{{ formatDateForSelector(date).day }}</div>
            <div class="day-month">{{ formatDateForSelector(date).month }}</div>
            <div class="day-label">D√≠a {{ i + 1 }}</div>
            <div class="day-total">{{ getTotalForDate(date) | number: '1.2-2' }}‚Ç¨</div>
          </button>
        }
      } @else {
        <p class="no-dates-message">No hay d√≠as disponibles</p>
      }
    </div>
  </div>


  <!-- SECCI√ìN 3: DETALLE DE GASTOS DEL D√çA SELECCIONADO -->
  <section class="daily-expenses-detail">
    <div class="detail-header">
      <h2 class="detail-title">
        D√≠a ‚Äì <span class="date-highlight">{{ formatDateComplete(selectedDate()) }}</span>
      </h2>
      <div class="header-right">
        <span class="daily-total">Total: {{ totalForSelectedDate() | number: '1.2-2' }} ‚Ç¨</span>
        <button 
          class="btn-add-day-expense" 
          (click)="openAddExpenseModalForDate(selectedDate())"
          aria-label="A√±adir gasto para este d√≠a">
          A√±adir +
        </button>
      </div>
    </div>

    <!-- Tabla de gastos -->
    @if (expensesForSelectedDate().length > 0) {
      <div class="expenses-table">
        <div class="table-header">
          <div class="col-description">Descripci√≥n:</div>
          <div class="col-amount">Monto:</div>
          <div class="col-payer">Pagado por:</div>
          <div class="col-split">Dividido:</div>
          <div class="col-actions"></div>
        </div>

        @for (expense of expensesForSelectedDate(); track expense.id) {
          <div class="table-row" [class.paid]="isExpensePaid(expense.id)">
            <div class="col-description">{{ expense.description }}</div>
            <div class="col-amount">{{ expense.amount | number: '1.2-2' }} ‚Ç¨</div>
            <div class="col-payer">
              <img 
                [src]="getParticipantAvatar(expense.payerId)"
                [alt]="getParticipantName(expense.payerId)"
                class="participant-avatar">
              <span class="payer-name">{{ getParticipantName(expense.payerId) }}</span>
            </div>
            <div class="col-split">{{ getSplitParticipantsText(expense.participants) }}</div>
            <div class="col-actions">
              <button 
                class="btn-details-green"
                (click)="openExpenseDetails(expense)"
                aria-label="Ver detalles del gasto">
                Ver Detalles
              </button>
              <button 
                class="btn-delete-pink"
                (click)="deleteExpense(expense.id)"
                aria-label="Eliminar gasto">
                <span class="delete-icon">üóëÔ∏è</span> Borrar
              </button>
            </div>
          </div>
        }
      </div>
    } @else {
      <div class="empty-state">
        <p>Sin gastos para este d√≠a</p>
      </div>
    }
  </section>

  <!-- SECCI√ìN 4: PAGOS PENDIENTES -->
  @if (pendingPayments().length > 0) {
    <section class="pending-payments-card">
      <h3 class="payments-title">Pagos Pendientes</h3>
      
      <div class="payments-list">
        @for (payment of pendingPayments(); track payment.id) {
          <div class="payment-item">
            <p class="payment-text">
              <strong>{{ payment.debtor }}</strong> debe <strong>{{ payment.amount | number: '1.2-2' }} ‚Ç¨</strong> a <strong>{{ payment.creditor }}</strong>
            </p>
            <button 
              class="btn-pay-pill"
              (click)="markPaymentAsSettled(payment.id)"
              aria-label="Marcar como pagado">
              Pagar
            </button>
          </div>
        }
      </div>
    </section>
  }

  <!-- MODAL PARA A√ëADIR GASTO -->
  @if (showAddExpenseModal()) {
    <app-add-expense-modal 
      [tripId]="tripId()"
      [participants]="participants()"
      [currentUserId]="currentUserId()"
      [currentUserName]="currentUserName()"
      [tripStartDate]="tripDateBounds().start"
      [tripEndDate]="tripDateBounds().end"
      [preselectedDate]="preselectedDate()"
      (close)="closeAddExpenseModal()">
    </app-add-expense-modal>
  }
</div>