<div class="expenses-page">
  <!-- SECCIÓN 1: RESUMEN DE GASTOS DEL VIAJE -->
  <article class="expenses-summary-card">
    <div class="summary-header">
      <h1 class="total-amount">{{ totalExpenses() | number: '1.2-2' }} €</h1>
      <p class="summary-label">Gastos totales del viaje</p>
      
      <!-- Información de presupuesto -->
      <div class="budget-info">
        <div class="budget-item">
          <span class="budget-label">Presupuesto:</span>
          <span class="budget-value">{{ tripBudget() | number: '1.2-2' }} €</span>
        </div>
        <div class="budget-item">
          <span class="budget-label">Restante:</span>
          <span class="budget-remaining" [class.over-budget]="remainingBudget() < 0">{{ remainingBudget() | number: '1.2-2' }} €</span>
        </div>
        <div class="budget-bar">
          <div class="budget-used" [style.width.%]="budgetPercentage()"></div>
        </div>
        <p class="budget-percentage">{{ budgetPercentage() | number: '1.0-0' }}% del presupuesto utilizado</p>
      </div>
    </div>

    <!-- Listado de gastos agregados por categoría -->
    <div class="aggregated-expenses">
      @if (aggregatedExpenses().length > 0) {
        @for (aggExpense of aggregatedExpenses(); track aggExpense.category) {
          <div class="aggregated-item">
            <div class="item-left">
              <p class="expense-name">{{ aggExpense.description }}</p>
              <p class="expense-subtitle">
                Pagado por: {{ aggExpense.payerNames }}
              </p>
              <p class="expense-date">{{ aggExpense.latestDate | date: 'MMMM d, yyyy' }}</p>
            </div>
            <div class="item-right">
              <span class="expense-amount">{{ aggExpense.total | number: '1.2-2' }} €</span>
            </div>
          </div>
        }
      } @else {
        <p class="no-expenses-text">Sin gastos aún</p>
      }
    </div>

    <!-- Botón de acción -->
    <div class="button-container">
      <button 
        class="btn-add-expense-pill" 
        (click)="openAddExpenseModal()"
        aria-label="Añadir nuevo gasto">
        S Añadir Gasto
      </button>
    </div>
  </article>

  <!-- SECCIÓN 2: SELECTOR DE DÍAS (Grid colorido - estilo Itinerario) -->
  <nav class="days-selector">
    <div class="days-selector__list">
      @for (day of days(); let i = $index; track day.dayIndex) {
        <button 
          class="day-card"
          [class.selected]="selectedDate() === (day.date | date: 'yyyy-MM-dd')"
          (click)="selectDate(day.date)"
          [attr.aria-pressed]="selectedDate() === (day.date | date: 'yyyy-MM-dd')"
          [attr.aria-label]="'Seleccionar ' + (day.date | date: 'EEEE, d MMMM' : undefined : 'es-ES')">
          <span class="day-card__day-name">{{ (day.date | date: 'EEE' : undefined : 'es-ES') }}</span>
          <span class="day-card__number">{{ (day.date | date: 'dd') }}</span>
          <span class="day-card__month">{{ capitalize((day.date | date: 'MMM' : undefined : 'es-ES') || '') }}</span>
        </button>
      }
    </div>
  </nav>

  <!-- SECCIÓN 3: DETALLE DE GASTOS DEL DÍA SELECCIONADO (Estilo Actividades) -->
  <main class="expenses-content">
    <!-- Day Header -->
    <div class="day-header">
      <div>
        <h1 class="day-title">{{ formatDateComplete(selectedDate()) }}</h1>
      </div>
      
      <!-- Monto total del día -->
      <div class="day-total-badge">
        <span class="day-total-amount">{{ totalForSelectedDate() | number: '1.2-2' }} €</span>
      </div>
    </div>

    <!-- Lista de Gastos (estilo Actividades) -->
    <section 
      class="expenses-container"
      [attr.aria-label]="'Gastos del día ' + formatDateComplete(selectedDate())">
      
      @if (expensesForSelectedDate().length === 0) {
        <div class="empty-state">
          <p class="empty-state__message">No hay gastos para este día</p>
          <p class="empty-state__hint">Pulsa el botón <strong style="color: var(--quaternary-color);">"Añadir Gasto"</strong> para crear uno nuevo</p>
        </div>
      } @else {
        <div class="expenses-list">
          @for (expense of expensesForSelectedDate(); let idx = $index; track expense.id) {
            <article 
              class="expense-card"
              [attr.data-expense-id]="expense.id">
              
              <!-- Main Content -->
              <div class="expense-card__content">
                <div class="expense-card__header">
                  <h3 class="expense-card__title">{{ expense.description }}</h3>
                  <span class="expense-card__amount-badge">{{ expense.amount | number: '1.2-2' }} €</span>
                </div>

                <!-- Payer Info -->
                <div class="expense-card__payer">
                  <img 
                    [src]="getParticipantAvatar(expense.payerId)"
                    [alt]="getParticipantName(expense.payerId)"
                    class="payer-avatar">
                  <div class="payer-info">
                    <span class="payer-label">Pagado por:</span>
                    <span class="payer-name">{{ getParticipantName(expense.payerId) }}</span>
                  </div>
                </div>

                <!-- Category -->
                <div class="expense-card__category">
                  <span class="category-icon">{{ getCategoryIcon(expense.category) }}</span>
                  <span class="category-name">{{ getCategoryDescription(expense.category) }}</span>
                </div>

                <!-- Participants Split -->
                @if (expense.participants.length > 0) {
                  <div class="expense-card__split">
                    <span class="split-label">Dividido entre:</span>
                    <span class="split-text">{{ getSplitParticipantsText(expense.participants) }}</span>
                  </div>
                }
              </div>

              <!-- Actions -->
              <div class="expense-card__actions">
                <button 
                  class="btn-icon"
                  (click)="openEditExpenseModal(expense)"
                  aria-label="Editar gasto"
                  title="Editar">
                  <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                  </svg>
                </button>
                <button 
                  class="btn-icon btn-icon--danger"
                  (click)="deleteExpense(expense.id)"
                  aria-label="Eliminar gasto"
                  title="Eliminar">
                  <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="3 6 5 6 21 6"></polyline>
                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                    <line x1="10" y1="11" x2="10" y2="17"></line>
                    <line x1="14" y1="11" x2="14" y2="17"></line>
                  </svg>
                </button>
              </div>
            </article>
          }
        </div>
      }

      <!-- Centered Add Expense Button -->
      <div style="display: flex; justify-content: center; padding-top: 2rem; padding-bottom: 4rem;">
        <button 
          class="btn-add-expense"
          (click)="openAddExpenseModal()"
          aria-label="Añadir nuevo gasto">
          Añadir gasto
        </button>
      </div>
    </section>
  </main>

  <!-- MODAL PARA AÑADIR/EDITAR GASTO -->
  @if (showAddExpenseModal()) {
    <div class="modal-overlay" (click)="closeAddExpenseModal()">
      <div class="modal-container" (click)="$event.stopPropagation()">
        <app-add-expense-modal 
          [tripId]="tripId()"
          [participants]="participants()"
          [currentUserId]="currentUserId()"
          [currentUserName]="currentUserName()"
          [tripStartDate]="tripDateBounds().start"
          [tripEndDate]="tripDateBounds().end"
          [preselectedDate]="selectedDate()"
          (close)="closeAddExpenseModal()"
          (expenseAdded)="onExpenseAdded($event)">
        </app-add-expense-modal>
      </div>
    </div>
  }
</div>