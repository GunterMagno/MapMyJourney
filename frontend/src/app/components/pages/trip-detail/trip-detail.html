<!-- Trip Detail Page - Complex Layout with Sidebar -->
<app-header></app-header>

<section class="trip-detail">
  <!-- Mobile Menu Toggle Button -->
  <button 
    class="trip-detail__mobile-menu-toggle"
    (click)="toggleMobileMenu()"
    [attr.aria-expanded]="mobileMenuOpen"
    aria-label="Abrir men√∫ de navegaci√≥n">
    <span></span>
    <span></span>
    <span></span>
  </button>

  <!-- Overlay para cerrar men√∫ en m√≥vil -->
  <article 
    *ngIf="mobileMenuOpen"
    class="trip-detail__overlay"
    (click)="toggleMobileMenu()"
    role="presentation">
  </article>

  <!-- Sidebar Navigation -->
  <aside 
    class="trip-detail__sidebar"
    [class.trip-detail__sidebar--open]="mobileMenuOpen"
    role="navigation"
    aria-label="Navegaci√≥n principal">
    
    <header class="trip-detail__sidebar-header">
      <h2 class="trip-detail__sidebar-title">{{ tripName() }}</h2>
      <button 
        class="trip-detail__sidebar-close"
        (click)="toggleMobileMenu()"
        aria-label="Cerrar men√∫">
        ‚úï
      </button>
    </header>

    <nav class="trip-detail__nav" role="navigation" aria-label="Secciones del viaje">
      <a 
        href="#itinerary"
        class="trip-detail__nav-link"
        [class.trip-detail__nav-link--active]="activeSection === 'itinerary'"
        (click)="switchSection('itinerary')"
        role="menuitem">
        üìÖ Itinerario
      </a>
      <a 
        href="#voting"
        class="trip-detail__nav-link"
        [class.trip-detail__nav-link--active]="activeSection === 'voting'"
        (click)="switchSection('voting')"
        role="menuitem">
        üó≥Ô∏è Votaciones
      </a>
      <a 
        href="#documents"
        class="trip-detail__nav-link"
        [class.trip-detail__nav-link--active]="activeSection === 'documents'"
        (click)="switchSection('documents')"
        role="menuitem">
        üìÑ Documentos
      </a>
      <a 
        href="#expenses"
        class="trip-detail__nav-link"
        [class.trip-detail__nav-link--active]="activeSection === 'expenses'"
        (click)="switchSection('expenses')"
        role="menuitem">
        üí∞ Gastos
      </a>
    </nav>

    <!-- Trip Info Card -->
    <article class="trip-detail__info-card">
      <h3>Informaci√≥n del Viaje</h3>
      <dl class="trip-detail__info-list">
        <dt>Fechas</dt>
        <dd>{{ formatTripDateRange() }}</dd>
        
        <dt>Ubicaci√≥n</dt>
        <dd>{{ tripLocation() }}</dd>
        
        <dt>Participantes</dt>
        <dd>{{ participantsCount() }}</dd>
      </dl>
    </article>

    <!-- Participants List -->
    <article class="trip-detail__participants">
      <h3>Participantes</h3>
      <ul class="trip-detail__participants-list">
        @for (participant of participants(); track participant.id) {
          <li class="trip-detail__participant">
            <span class="trip-detail__participant-avatar">{{ getInitials(participant.name) }}</span>
            <span class="trip-detail__participant-name">{{ participant.name }}</span>
          </li>
        }
      </ul>
    </article>
  </aside>

  <!-- Main Content -->
  <main class="trip-detail__main" role="main">
    
    <!-- Itinerary Section -->
    <section 
      id="itinerary"
      class="trip-detail__section"
      *ngIf="activeSection === 'itinerary'">
      <h2 class="trip-detail__section-title">Itinerario</h2>
      
      <article class="trip-detail__timeline">
        <article 
          class="trip-detail__timeline-item"
          *ngFor="let day of itineraryDays; let i = index">
          <header class="trip-detail__timeline-date">
            <span class="trip-detail__timeline-day">D√≠a {{ i + 1 }}</span>
            <span class="trip-detail__timeline-date-text">{{ formatDate(day.date) }}</span>
          </header>
          
          <article class="trip-detail__timeline-content">
            <h3 class="trip-detail__timeline-title">{{ day.title }}</h3>
            <p class="trip-detail__timeline-description">{{ day.description }}</p>
            
            <section class="trip-detail__activities">
              <article 
                class="trip-detail__activity"
                *ngFor="let activity of day.activities">
                <span class="trip-detail__activity-icon">{{ activity.icon }}</span>
                <div>
                  <h4 class="trip-detail__activity-title">{{ activity.title }}</h4>
                  <p class="trip-detail__activity-details">{{ activity.time }} ‚Ä¢ {{ activity.location }}</p>
                </div>
              </article>
            </section>
          </article>
        </article>
      </article>
    </section>

    <!-- Voting Section -->
    <section 
      id="voting"
      class="trip-detail__section"
      *ngIf="activeSection === 'voting'">
      <h2 class="trip-detail__section-title">Votaciones</h2>
      
      <section class="trip-detail__voting-grid">
        <article 
          class="trip-detail__voting-card"
          *ngFor="let proposal of proposals">
          <h3 class="trip-detail__voting-title">{{ proposal.title }}</h3>
          <p class="trip-detail__voting-description">{{ proposal.description }}</p>
          
          <section class="trip-detail__voting-options">
            <button 
              *ngFor="let option of proposal.options"
              class="trip-detail__voting-option"
              [class.trip-detail__voting-option--selected]="option.userVoted"
              [attr.aria-pressed]="option.userVoted">
              <span class="trip-detail__voting-option-label">{{ option.label }}</span>
              <span class="trip-detail__voting-option-count">{{ option.votes }} votos</span>
              <div class="trip-detail__voting-option-bar">
                <div 
                  class="trip-detail__voting-option-fill"
                  [style.width.%]="(option.votes / proposal.totalVotes) * 100">
                </div>
              </div>
            </button>
          </section>
        </article>
      </section>
    </section>

    <!-- Documents Section -->
    <section 
      id="documents"
      class="trip-detail__section"
      *ngIf="activeSection === 'documents'">
      <h2 class="trip-detail__section-title">Documentos</h2>
      
      <section class="trip-detail__documents-list">
        <article 
          class="trip-detail__document-item"
          *ngFor="let doc of documents">
          <span class="trip-detail__document-icon">{{ getDocumentIcon(doc.type) }}</span>
          <article class="trip-detail__document-info">
            <h3 class="trip-detail__document-name">{{ doc.name }}</h3>
            <p class="trip-detail__document-meta">{{ doc.uploadedBy }} ‚Ä¢ {{ formatDate(doc.date) }}</p>
          </article>
          <button 
            class="trip-detail__document-download"
            (click)="downloadDocument(doc.id)"
            aria-label="Descargar {{ doc.name }}">
            üì•
          </button>
        </article>
      </section>
    </section>

    <!-- Expenses Section -->
    <section 
      id="expenses"
      class="trip-detail__section"
      *ngIf="activeSection === 'expenses'">
      <h2 class="trip-detail__section-title">Gastos</h2>
      
      <!-- ERROR STATE -->
      @if (expenseError()) {
        <article class="trip-detail__error" role="alert">
          <p>{{ expenseError() }}</p>
          <button (click)="expenseStore.loadExpensesByTrip(tripId)">
            Reintentar
          </button>
        </article>
      }

      <!-- EXPENSE SUMMARY (con computed signals autom√°ticos) -->
      <header class="trip-detail__expense-summary">
        <!-- ‚úÖ totalBudgetUsed es un computed signal que se actualiza autom√°ticamente -->
        <article class="trip-detail__expense-stat">
          <span class="trip-detail__expense-stat-label">Gasto Total</span>
          <span class="trip-detail__expense-stat-value">‚Ç¨{{ totalBudgetUsed() | number: '1.2-2' }}</span>
        </article>
        
        <!-- ‚úÖ averageExpense se recalcula cuando cambian expenses -->
        <article class="trip-detail__expense-stat">
          <span class="trip-detail__expense-stat-label">Promedio por Persona</span>
          <span class="trip-detail__expense-stat-value">‚Ç¨{{ averageExpense() | number: '1.2-2' }}</span>
        </article>

        <!-- ‚úÖ Gasto m√°s alto -->
        <article class="trip-detail__expense-stat">
          <span class="trip-detail__expense-stat-label">Gasto M√°ximo</span>
          <span class="trip-detail__expense-stat-value">‚Ç¨{{ maxExpense() | number: '1.2-2' }}</span>
        </article>
      </header>

      <!-- DESGLOSE POR CATEGOR√çA (computed signal) -->
      @if (expensesByCategory() && (expensesByCategory() | keyvalue).length > 0) {
        <section class="trip-detail__expense-breakdown">
          <h3>Gastos por Categor√≠a</h3>
          <ul class="trip-detail__breakdown-list">
            @for (item of (expensesByCategory() | keyvalue); track item.key) {
              <li class="trip-detail__breakdown-item">
                <span class="trip-detail__breakdown-category">{{ item.key }}</span>
                <output class="trip-detail__breakdown-amount">‚Ç¨{{ item.value | number: '1.2-2' }}</output>
              </li>
            }
          </ul>
        </section>
      }

      <!-- LOADING STATE -->
      @if (expenseLoading()) {
        <section class="trip-detail__loading" role="status" aria-label="Cargando gastos">
          <progress value="50" max="100"></progress>
          <p>Cargando gastos...</p>
        </section>
      }

      <!-- EMPTY STATE -->
      @if (expenses().length === 0 && !expenseLoading()) {
        <article class="trip-detail__empty">
          <p>Sin gastos registrados a√∫n</p>
        </article>
      }

      <!-- EXPENSES LIST (CON INFINITE SCROLL) -->
      @if (expenses().length > 0) {
        <section class="trip-detail__expenses-list">
          <!-- ‚úÖ @for con track para preservar DOM -->
          @for (expense of expenses(); track trackExpenseById(expense)) {
            <article class="trip-detail__expense-card">
              <header class="trip-detail__expense-header">
                <h3 class="trip-detail__expense-title">{{ expense.category }}</h3>
                <span class="trip-detail__expense-amount">‚Ç¨{{ expense.amount | number: '1.2-2' }}</span>
              </header>
              
              <p class="trip-detail__expense-description">{{ expense.description }}</p>
              
              <footer class="trip-detail__expense-meta">
                <span class="trip-detail__expense-payer">{{ expense.payer.name }}</span>
                <span class="trip-detail__expense-date">{{ formatDate(expense.date) }}</span>
                <button 
                  class="trip-detail__expense-delete"
                  (click)="deleteExpense(expense.id)"
                  aria-label="Eliminar gasto">
                  üóëÔ∏è
                </button>
              </footer>
            </article>
          }
        </section>

        <!-- ‚úÖ INFINITE SCROLL SENTINEL -->
        <span 
          #expenseScrollAnchor
          role="status"
          aria-live="polite"
          aria-label="Cargando m√°s gastos">
        </span>

        <!-- FIN DE DATOS -->
        @if (!expenseStore.hasMore() && !expenseLoading()) {
          <output class="trip-detail__end-message">
            Has visto todos los gastos de este viaje
          </output>
        }

        <!-- CONTADOR DE GASTOS -->
        <output class="trip-detail__expense-counter">
          Total: {{ expenseTotalTrips() }} gasto<span *ngIf="expenseTotalTrips() !== 1">s</span>
        </output>
      }
    </section>
  </main>
</section>

<app-footer></app-footer>
