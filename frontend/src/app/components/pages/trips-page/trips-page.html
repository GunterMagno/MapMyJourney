<app-header></app-header>

<section class="trips-page">
  <!-- HEADER CON FILTROS -->
  <section class="trips-page__header">
    <div class="trips-page__header-top">
      <h1>Mis Viajes</h1>
      <app-button
        label="Crear Nuevo Viaje"
        variant="primary"
        size="lg"
        (click)="createTrip()">
      </app-button>
    </div>
    
    <!-- FILTROS DE ORDENAMIENTO -->
    <app-trips-filters></app-trips-filters>
  </section>

  <!-- CONTADOR DE VIAJES -->
  @if (trips().length > 0) {
    <output class="trips-page__counter">
      Total: {{ totalTrips() }} viaje<span *ngIf="totalTrips() !== 1">s</span>
    </output>
  }

  <!-- ERROR STATE - NUNCA MOSTRAR ERROR AL USUARIO, SOLO EN TOASTS -->

  <!-- EMPTY STATE - Solo si no hay viajes Y no está cargando -->
  @if (trips().length === 0 && !loading()) {
    <article class="trips-page__empty">
      <p>No tienes viajes registrados aún.</p>
      <app-button
        label="Crear tu primer viaje"
        variant="primary"
        (click)="createTrip()">
      </app-button>
    </article>
  }

  <!-- TRIPS GRID CON INFINITE SCROLL -->
  @if (trips().length > 0) {
    <section class="trips-page__grid">
      @for (trip of trips(); track trackById(trip)) {
        <div class="card-container" (click)="viewTrip(trip.id)">
          <app-card 
            [title]="trip.title"
            [image]="trip.imageUrl"
            variant="vertical">
            
            <div class="trip-info">
              <div class="trip-info__destination">
                <span class="trip-info__label">Destino:</span>
                <span class="trip-info__value">{{ trip.destination }}</span>
              </div>

              @if (trip.description) {
                <div class="trip-info__description">
                  <span class="trip-info__label">Descripción:</span>
                  <span class="trip-info__value">{{ trip.description }}</span>
                </div>
              }

              <div class="trip-info__dates">
                <span class="trip-info__label">Fechas:</span>
                <span class="trip-info__value">{{ trip.startDate | date: 'dd/MM/yyyy' }} - {{ trip.endDate | date: 'dd/MM/yyyy' }}</span>
              </div>
              
              <div class="trip-info__budget">
                <div class="trip-info__item">
                  <span class="trip-info__label">Presupuesto:</span>
                  <span class="trip-info__value">€{{ trip.budget || 0 }}</span>
                </div>
                <div class="trip-info__item">
                  <span class="trip-info__label">Gastado:</span>
                  <span class="trip-info__value trip-info__value--spent">€{{ trip.totalExpenses || 0 }}</span>
                </div>
              </div>
              
              <div class="trip-card__button-wrapper">
                <app-button
                  label="Ver Detalles"
                  variant="primary"
                  size="md"
                  (click)="viewTrip(trip.id); $event.stopPropagation()">
                </app-button>
              </div>
            </div>
          </app-card>
        </div>
      }
    </section>

    <!-- ✅ INFINITE SCROLL SENTINEL -->
    <!-- Este elemento se observa con IntersectionObserver -->
    <!-- Cuando se vuelve visible, carga más viajes -->
    <span 
      #scrollAnchor
      role="status"
      aria-live="polite"
      aria-label="Cargando más viajes">
    </span>

    <!-- LOADING STATE DURANTE INFINITE SCROLL -->
    @if (loading() && trips().length > 0) {
      <section class="trips-page__loading" role="status" aria-label="Cargando viajes">
        <p>Cargando más viajes...</p>
      </section>
    }

    <!-- FIN DE DATOS -->
    @if (!hasMore() && trips().length > 0 && !loading()) {
      <output class="trips-page__end-message">
        Has alcanzado el final de tus viajes
      </output>
    }
  }

</section>

<app-footer></app-footer>

<!-- Modal para crear viaje -->
<app-create-trip-modal
  #createTripModal
  (tripCreated)="onTripCreated($event)">
</app-create-trip-modal>
